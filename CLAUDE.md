# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

**Important**: When you learn something new about this project or make changes that affect information documented here, update this file at the same time to keep it accurate.

## Project Overview

This is a Splunk Add-on for MaxMind GeoIP lookups, built using the Splunk UCC (Universal Configuration Console) framework. It provides a custom streaming search command (`maxmind`) that performs country lookups using MaxMind databases.

## Commands

```bash
# Setup environment
mise install                      # Install Python 3.13
uv sync                           # Install build dependencies
git submodule update --init       # Initialize test data submodule

# Build the add-on
./build.sh      # Generates output/ directory and .tar.gz package

# Run tests
uv run pytest tests

# Install to Splunk (requires Splunk 10.2)
splunk install app /path/to/demo_addon_for_splunk-1.0.0.tar.gz
splunk install app /path/to/demo_addon_for_splunk-1.0.0.tar.gz -update true  # Update existing
```

## Project Structure

```
demo_addon_for_splunk/
├── globalConfig.json      # Main configuration file for UCC framework
├── package/
│   ├── app.manifest       # Add-on metadata (author, version, description)
│   ├── default/
│   │   ├── app.conf       # Splunk app configuration (merged with generated)
│   │   └── commands.conf  # Search command configuration (replaces generated)
│   ├── bin/               # Python scripts (inputs, custom commands)
│   ├── lib/
│   │   └── requirements.txt  # Python dependencies for the add-on
│   ├── static/            # Icons and images
│   └── data/              # Data files (e.g., MaxMind databases)
```

## Tests

Tests live in `tests/` and use pytest with unittest.TestCase style. Test data comes from the `MaxMind-DB` git submodule at `tests/data/`.

```
tests/
├── conftest.py              # Sets MAXMIND_DB_PATH to test database
├── data/                    # MaxMind-DB submodule (git submodule)
│   └── test-data/           # Contains test .mmdb files
└── maxmind_command_test.py  # Tests using GeoIP2-Country-Test.mmdb
```

The `MAXMIND_DB_PATH` environment variable overrides the database path, allowing tests to use `GeoIP2-Country-Test.mmdb` instead of the production database.

Test IPs from GeoIP2-Country-Test.mmdb:
- `214.78.120.0/22` → US
- `2001:218::/32` → JP
- `2001:220::1/128` → KR

## Key Configuration Files

### globalConfig.json

The main UCC configuration file. Defines:
- Input types and their parameters
- Configuration tabs (accounts, logging)
- Custom search commands
- UI settings

### package/app.manifest

JSON file with add-on metadata:
```json
{
  "info": {
    "author": [{"name": "...", "email": "...", "company": "..."}],
    "title": "...",
    "description": "..."
  }
}
```

### package/default/app.conf

Custom settings merged into the generated `app.conf`. Example:
```ini
[launcher]
author = William Storey
```

### package/default/commands.conf

Custom search command configuration. Unlike `app.conf`, UCC **replaces** (not merges) this file, so you must include all required settings:
```ini
[maxmind]
filename = maxmind.py
chunked = true
python.version = python3
python.required = 3.13
```

- `chunked = true` is required for streaming commands using the Splunk SDK
- `python.version` is for backward compatibility with Splunk < 10.2
- `python.required` is used by Splunk 10.2+ (takes precedence over `python.version`)

## Dependencies

- **Build dependencies**: in `pyproject.toml` (managed by uv)
- **Add-on runtime dependencies**: in `package/lib/requirements.txt` (installed into add-on's lib/)

When updating dependencies, check both locations to ensure they stay in sync.

## UCC Framework Behavior

- UCC generates `.conf` files in the output `default/` directory
- For `app.conf`: UCC merges your settings with generated ones
- For `commands.conf`: UCC **replaces** the generated file entirely with yours (include all required settings)
- UCC automatically sets `python.version = python3` in generated `commands.conf` and `inputs.conf`
- Warning about "not auto generated by UCC framework" for custom settings is expected

## Splunk Python Version Configuration

In Splunk 10.2+, `python.version` is deprecated. Use `python.required` instead:
- `python.required = 3.13` uses just the version number (not "python3.13")
- Default `python.version = python3` resolves to Python 3.9 in Splunk 10.2, not the latest
- Include both settings for backward compatibility with older Splunk versions
- The `maxminddb` 3.0.0 package requires Python 3.10+ (uses `kw_only` in dataclasses)

## Reinstalling the Add-on

When reinstalling, fully remove the old app first to avoid cached libraries:
```bash
splunk remove app demo_addon_for_splunk
splunk restart
splunk install app /path/to/demo_addon_for_splunk-1.0.0.tar.gz
```

## Key Constraints

- The `author` field in `package/default/app.conf` must exactly match the first author name in `package/app.manifest`
